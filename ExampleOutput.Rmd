---
title: "Example Output"
output: 
  html_document:
    code_download: yes
    code_folding: hide
    toc: true
    toc_float:
      collapsed: false
params:
  import.file: "data/HolzingerSwineford1939.csv"       # Relative file path to data
  mimic: "lavaan"       # Which software program to mimic for estimating models
  missing: "ML"         # How to deal with missing values: "ML" or "listwise"
  std.lv: TRUE          # For CFAs, default setting whether to set latent variances to 1 or not
  std.ov: FALSE         # Staandardize all observed varialbes?
  se: "standard"        # How to calcualte standard errors: "standard" or "bootstrap"
  bootstrap: 1000       # If se = "bootstrap" how many boostrap samples?
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(error = TRUE, message = FALSE, warning = TRUE)
```

# {.tabset .tabset-pills}

**NOTE: We will actually use two data sets in this example output. They come from the `lavaan` tutorial data sets; cfa data set is`HolzingerSwineford1939` and sem data set is `PoliticalDemocracy`**

**NOTE: You can download the RMarkdown file associated with this output by selecting the 'Code' button on the top-right of this document and selecting "Download Rmd". You can also display the code used to produce each output by selecting the 'Code' buttons along the right of the document.** 


**NOTE: for the entire document there are 2 tabs:**

- The "Results" tab contains ALL the results output

- The "Session Infor" tab contains information about the current R Session including what packages were loaded, how to cite the `lavaan` package and how to cite the R statistical software.

**NOTE: For each CFA or SEM model output there are 4 tabs:**

- The "Summary Output" tab display nice looking tables summarizing the model results

- The "Diagram Output" tab will display a model diagram

- The "Residual Correlation Matrix" tab will display the residual correlation matrix

- The "Full Output" tab will display the results from `summary()` along with parameter estimates and modification indices. This way you can still get the full output from a lavaan model as it provides more information than the "Summary Output". You can also add additional output to this section if you need more info about the model.

**Once you install the package, you will be able to access this Rmarkdown template by going to**:

File -> New File -> R Markdownâ€¦ -> From Template -> CFA/SEM (lavaan)

In the YAML header you will need to specify the default parameters (select the 'Code' button to the right):

```{r eval=FALSE, }
params:
  import.file: ""       # Relative file path to data
  mimic: "lavaan"       # Which software program to mimic for estimating models
  missing: "ML"         # How to deal with missing values: "ML" or "listwise"
  std.lv: TRUE          # For CFAs, default setting whether to set latent variances to 1 or not
  std.ov: FALSE         # Staandardize all observed varialbes?
  se: "standard"        # How to calcualte standard errors: "standard" or "bootstrap"
  bootstrap: 1000       # If se = "bootstrap" how many boostrap samples?
```



Last updated: `r format(Sys.Date(), "%B %d %Y")`

## Results

### Setup

Required Packages
```{r warning=FALSE}
library(readr)
library(lavaan)
library(semoutput)
library(semPlot)
library(sjPlot)
```


Import Data

Data file: `r params$import.file`

```{r warning=FALSE, eval = FALSE}
## Import Data
data <- read_csv(params$import.file)
```

```{r}
cfa_data <- dplyr::select(HolzingerSwineford1939, -id, -school)
sem_data <- PoliticalDemocracy
```


lavaan parameters:

mimic = `r params$mimic`

missing = `r params$missing`

std.lv = `r params$std.lv`

std.ov = `r params$std.ov`

se = `r params$se`

bootstrap = `r params$bootstrap`

---

---

### Descriptives 

Typically there is only one descriptive table displayed but since we have two data sets for this one output two descriptive tables are displayed.

```{r}
# Prints basic descriptive statistics
sem_descriptives(cfa_data)
sem_descriptives(sem_data)
```

---

### Correlation Matrix

There are also two correlation matrices

This is a publication quality correlation matrix that can be inserted into a manuscript.

```{r}
# Uses sjPlot to print a nice looking correlation table
sjt.corr(cfa_data, na.deletion = "pairwise", digits = 2, triangle = "lower")
sjt.corr(sem_data, na.deletion = "pairwise", digits = 2, triangle = "lower")
```

---
---

### CFA {.tabset .tabset-pills}

```{r comment=''}
# factors is a list of the latent factor names. To be used for printing lavaan output to nice looking tables. Not needed to run actual lavaan model
factors <- c("visual", "textual", "speed")
# Specify the model parameters. Must be incased within single or double quotes. Can add labels to organize parameter specifications. I provided just some example labels, they are not required though and you can use whatever labels you want. You need to know how lavaan works! See http://lavaan.ugent.be/tutorial/index.html for more information on how to specify the model parameters
model <- '
# latent factors
visual =~ x1 + x2 + x3
textual =~ x4 + x5 + x6
speed =~ x7 + x8 + x9

# correlated errors

# constraints

'
# You might want to specify other arguments. But this is pretty standard. 
#std.lv = TRUE means that the latent factor variances are set to 1. If False, then the path for the first variable on the factor specificed in the model will be set to 1.
fit <- cfa(model = model, data = cfa_data, 
           mimic = params$mimic, missing = params$missing, 
           std.lv = params$std.lv, std.ov = params$std.ov,
           se = params$se, bootstrap = params$bootstrap)
cat("Model: \n", model)
```


#### Summary Output
```{r}
## This tab will print out summary result tables with the most important information. Fit stats, standardized path values, etc...
sem_sig(fit)
sem_fitmeasures(fit)
sem_factorloadings(fit, standardized = TRUE, ci = "standardized")
sem_factorcor(fit, factors = factors)
sem_factorvar(fit, factors = factors)
sem_rsquared(fit)
```

#### Diagram Output
```{r}
## This tab will print out a model diagram. Pretty freak'n cool!
semPaths(fit, latents = factors, whatLabels = "std", layout = "tree2", 
         rotation = 2, style = "lisrel", optimizeLatRes = TRUE, 
         intercepts = FALSE, residuals = TRUE, curve = 1, curvature = 3, 
         sizeLat = 10, nCharNodes = 8, sizeMan = 11, sizeMan2 = 4, 
         edge.label.cex = 1.2, edge.color = "#000000")
## If you want to modify the plot see ?semPlot::semPaths for argument descriptions
```

#### Residual Correlation Matrix
```{r}
## If you want to see the residual correlation matrix
sem_residuals(fit)
```


#### Full Output

##### Summary
```{r}
summary(fit, fit.measures = TRUE, standardized = TRUE)
```

##### Parameter Estimates
```{r}
standardizedSolution(fit)
```


##### Modification Indices
```{r}
modificationIndices(fit, sort. = TRUE, minimum.value = 3)
```

---
---

### SEM {.tabset .tabset-pills}

```{r comment=''}
# factors is a list of the latent factor names. To be used for printing lavaan output to nice looking tables. Not needed to run actual lavaan model
factors <- c("dem60", "ind60", "dem65")
# Specify the model parameters. Must be incased within single or double quotes. Can add labels to organize parameter specifications. I provided just some example labels, they are not required though and you can use whatever labels you want. You need to know how lavaan works! See http://lavaan.ugent.be/tutorial/index.html for more information on how to specify the model parameters
model <- '
# measurement model
ind60 =~ x1 + x2 + x3
dem60 =~ y1 + y2 + y3 + y4
dem65 =~ y5 + y6 + y7 + y8

# regressions
dem60 ~ ind60
dem65 ~ ind60 + dem60

# covariances
y1 ~~ y5
y2 ~~ y4 + y6
y3 ~~ y7
y4 ~~ y8
y6 ~~ y8

# variances

'
# You might want to specify other arguments. But this is pretty standard. 
#std.lv = TRUE means that the latent factor variances are set to 1. If False, then the path for the first variable on the factor specificed in the model will be set to 1. For an SEM, it is better to set as FALSE. And if you want a latent factor variance set to 1 then specify it in the model and include NA* before the first variable on the factor. See http://lavaan.ugent.be/tutorial/index.html for more details
fit <- sem(model = model, data = sem_data, 
           mimic = params$mimic, missing = params$missing, 
           std.lv = FALSE, std.ov = params$std.ov,
           se = params$se, bootstrap = params$bootstrap)
cat("Model: \n", model)
```

#### Summary Output
```{r}
## This tab will print out summary result tables with the most important information. Fit stats, standardized path values, etc...
sem_sig(fit)
sem_fitmeasures(fit)
sem_factorloadings(fit, standardized = TRUE, ci = "standardized")
sem_paths(fit, standardized = TRUE, ci = "standardized")
sem_factorcor(fit, factors = factors)
sem_factorvar(fit, factors = factors)
sem_rsquared(fit)
```

#### Diagram Output

In the Rmarkdown document I changed the r-code chunck option for figure width to `fig.width = 10` to make the image wider. Notice in the 'Code' I also changed the default paramter for edge labels to `edge.label.cex = 8`.

```{r fig.width=10}
## This tab will print out a model diagram. Pretty freak'n cool!
semPaths(fit, latents = factors, whatLabels = "std", layout = "tree2", 
         rotation = 2, style = "lisrel", optimizeLatRes = TRUE, 
         intercepts = FALSE, residuals = TRUE, curve = 1, curvature = 3, 
         sizeLat = 10, nCharNodes = 8, sizeMan = 11, sizeMan2 = 4, 
         edge.label.cex = .8, edge.color = "#000000")
## If you want to modify the plot see ?semPlot::semPaths for argument descriptions
```

#### Residual Correlation Matrix
```{r}
## If you want to see the residual correlation matrix
sem_residuals(fit)
```


#### Full Output

##### Summary
```{r}
summary(fit, fit.measures = TRUE, standardized = TRUE)
```

##### Parameter Estimates
```{r}
standardizedSolution(fit)
```


##### Modification Indices
```{r}
modificationIndices(fit, sort. = TRUE, minimum.value = 3)
```
---

---

## Session Info
```{r comment=""}
citation("lavaan")
citation()
sessionInfo()
```
